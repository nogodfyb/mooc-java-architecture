# 池化技术种类

![](img\1.png)

## 对象池

## ![](img\2.png)

![](img\3.png)

## 

![](img\4.png)

![](img\5.png)

![](img\6.png)

PooledObject状态

![](img\7.png)

demo

```xml
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

```java
package com.imooc.jvm.objectpool.commonspool;

import java.math.BigDecimal;

public class Money {
  public static Money init() {
    // 假设对象new非常耗时
    try {
      Thread.sleep(10L);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    return new Money("USD", new BigDecimal("1"));
  }

  private String type;

  private BigDecimal amount;

  public Money(String type, BigDecimal amount) {
    try {
      Thread.sleep(100L);
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
    this.type = type;
    this.amount = amount;
  }

  public String getType() {
    return type;
  }

  public void setType(String type) {
    this.type = type;
  }

  public BigDecimal getAmount() {
    return amount;
  }

  public void setAmount(BigDecimal amount) {
    this.amount = amount;
  }
}
```

```java
package com.imooc.jvm.objectpool.commonspool;

import org.apache.commons.pool2.PooledObject;
import org.apache.commons.pool2.PooledObjectFactory;
import org.apache.commons.pool2.impl.DefaultPooledObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.math.BigDecimal;

public class MoneyPooledObjectFactory implements PooledObjectFactory<Money> {

    public static final Logger LOGGER =
            LoggerFactory.getLogger(MoneyPooledObjectFactory.class);

    @Override
    public PooledObject<Money> makeObject() throws Exception {
        DefaultPooledObject<Money> object = new DefaultPooledObject<>(
                new Money("USD", new BigDecimal("1"))
        );
        LOGGER.info("makeObject..state = {}", object.getState());
        return object;
    }

    @Override
    public void destroyObject(PooledObject<Money> p) throws Exception {
        LOGGER.info("destroyObject..state = {}", p.getState());
    }

    @Override
    public boolean validateObject(PooledObject<Money> p) {
        LOGGER.info("validateObject..state = {}", p.getState());
        return true;
    }

    @Override
    public void activateObject(PooledObject<Money> p) throws Exception {
        LOGGER.info("activateObject..state = {}", p.getState());
    }

    @Override
    public void passivateObject(PooledObject<Money> p) throws Exception {
        LOGGER.info("passivateObject..state = {}", p.getState());
    }

}
```

```java
public static void main(String[] args) throws Exception {

    GenericObjectPoolConfig config = new GenericObjectPoolConfig();
    config.setMaxTotal(100);
    config.setMaxIdle(100);

    GenericObjectPool<Money> pool = new GenericObjectPool<>(new MoneyPooledObjectFactory(),config);
    Money money = pool.borrowObject();
    money.setType("RMB");
    pool.returnObject(money);

    for (int i = 0; i < 100; i++) {
        System.out.println(i + ":" + pool.borrowObject().getType());
    }

}
```

## 线程池

![](img\8.png)

![](img\9.png)

![](img\10.png)

![](img\11.png)

![](img\12.png)

![](img\13.png)

![](img\14.png)

![](img\15.png)

### ThreadPoolExecutor

demo

```java
package com.imooc.jvm.threadpool;

import java.util.concurrent.*;

public class ThreadPoolTest {
  public static void main(String[] args) throws ExecutionException, InterruptedException {
    ThreadPoolExecutor executor =
      new ThreadPoolExecutor(
        5,
        10,
        // 默认情况下指的是非核心线程的空闲时间
        // 如果allowCoreThreadTimeOut=true：核心线程/非核心线程允许的空闲时间
        10L,
        TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(100),
        Executors.defaultThreadFactory(),
        new ThreadPoolExecutor.AbortPolicy()
      );
    executor.allowCoreThreadTimeOut(true);
    // 核心线程 -> 正式员工
    // 非核心线程 -> 临时工
    executor.execute(() -> System.out.println("线程池测试"));

    executor.execute(() -> System.out.println("线程池测试2"));

    Future<String> future = executor.submit(() -> "测试submit");
    String s = future.get();
    System.out.println(s);

  }
  
}
```

#### BlockingQueue

![](img\16.png)

![](img\17.png)

![](img\18.png)

![](img\19.png)

![](img\20.png)

#### 调优技巧

???

待总结。

### ScheduledThreadPoolExecutor

![](img\21.png)